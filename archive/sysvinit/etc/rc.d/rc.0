#! /bin/sh
#
# /etc/rc.d/rc.0
#
# Prepares to halt or reboot the system.
#
# (#)1.00  2013-07-23 (MAF)
#
# Made for Dragora GNU/Linux-Libre version 3
# by Matias A. Fonzo, <selk@dragora.org>.
#
# Under the terms of the GNU General Public License.

PATH=/sbin:/bin

LC_ALL=C
export LC_ALL

# Save the random number generator
echo "/etc/random-seed:  Saving random seed from /dev/urandom ..."

# Take the default value, or use 2048 bytes
bytes=$(cat /proc/sys/kernel/random/poolsize 2> /dev/null) || bytes=2048;

# Save into the seed file
dd if=/dev/urandom of=/etc/random-seed count=1 bs=$bytes 2> /dev/null
chmod 0600 /etc/random-seed

# We don't KILL. We send the TERM signal
echo "Sending the TERM signal to all process ..."
killall5 -15
sleep 7

# Deactivate swap partitions or swap files
echo "*** Deactivating swap device(s), if any ..."
swapoff -v -a

# Flush file system buffers, update the super block
sync &

echo "*** Unmounting local and network file systems ..."
umount -v -a -f -t noproc,nosysfs,nodevtmpfs

# Wait until sync(1) is complete
wait $!

# We try to set the root filesystem in read-only mode,
# obtaining the device name through /dev/root. If it fails,
# or it is not a valid symbolic link, we try to remount
if [ -L /dev/root ] && [ -e /dev/root ] ; then
  echo "* Setting the root filesystem in read-only mode ..."
  blockdev -v --setro /dev/root
  if [ $? -ne 0 ] ; then
    echo "* Remounting the root filesystem in read-only mode:"
    mount -v -n -o remount,ro /    
  fi
else
  echo "* Remounting the root filesystem in read-only mode:"
  mount -v -n -o remount,ro /    
fi

# Wait for completion of all process
wait

# Reboot, or halt the system (power off)
case "$0" in
  *6)
    echo "Rebooting ..."
    reboot -d
    ;;
  *)
    halt -d -p;
esac

