#! /bin/sh
#  Copyright (C) 2012-2013  Matias A. Fonzo
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Autodetermine the path of /tools
if [ ! -L /tools ]; then
  echo "Cannot determine \$ROOT. The symlink \"/tools\" doesn't exists."
  exit 1
fi
if [ -L /tools ] && [ ! -e /tools ]; then
  echo "/tools is a dangling symlink."
  exit 1
fi
ROOT=$(readlink /tools | sed -e 's/\/tools//' -e 's/^/\//')

# Functions
_umount() {
  NODE="$1"
  echo "Unmounting $NODE ..."
  if ! umount $NODE ; then
    echo "Forcing ..."
    sleep 1
    umount -f $NODE
  fi
}

echo "Mounting directories ..."
mkdir -p \
 ${ROOT}/storage/dragora/archive \
 ${ROOT}/storage/dragora/patches \
 ${ROOT}/storage/dragora/recipes \
 ${ROOT}/storage/dragora/sources
mount -o bind "$(pwd)/archive" ${ROOT}/storage/dragora/archive
mount -o bind "$(pwd)/patches" ${ROOT}/storage/dragora/patches
mount -o bind "$(pwd)/recipes" ${ROOT}/storage/dragora/recipes
mount -o bind "$(pwd)/sources" ${ROOT}/storage/dragora/sources

echo "Mounting virtual file systems ..."
mount -o bind /dev ${ROOT}/kernel/devices
mount -t devpts devpts ${ROOT}/kernel/devices/pts
mount -t tmpfs shm ${ROOT}/kernel/devices/shm
mount -t proc proc ${ROOT}/kernel/process
mount -t sysfs sysfs ${ROOT}/kernel/objects

echo "Entering chroot (${ROOT}) ..."
chroot $ROOT /tools/bin/env -i \
 PATH=/executable:/tools/bin \
 SHELL=/executable/sh \
 TERM="$TERM" \
 PS1='\u:\w\$ ' \
 HOME=/users/root \
 LC_ALL=POSIX \
 /executable/sh --login

_umount ${ROOT}/storage/dragora/archive
_umount ${ROOT}/storage/dragora/patches
_umount ${ROOT}/storage/dragora/recipes
_umount ${ROOT}/storage/dragora/sources
_umount ${ROOT}/kernel/objects
_umount ${ROOT}/kernel/process
_umount ${ROOT}/kernel/devices/shm
_umount ${ROOT}/kernel/devices/pts
_umount ${ROOT}/kernel/devices

echo;  ## A new line for the prompt

