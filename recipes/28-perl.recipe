# Build recipe for perl.
#
# Copyright (C) 2012-2013 Matias A. Fonzo.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program = perl
version = 5.16.3
release = 1

tarname = ${program}-${version}.tar.lz
jobs = 1

docs = AUTHORS Artistic Changes Copying README README.linux
destdir = /pkg/${program}-${version}
docdir = ${destdir}/share/doc/${program}-${version}

[build]
cd $srcdir

# Look for the static libc
patch -Np0 -i ${patchdir}/perl-linux-static.sh

# Don't use -fstack-protector
patch -Np0 -i ${patchdir}/perl-fnostack-protector

# less of busybox doesn't support the '-R' option
patch -Np0 -i ${patchdir}/perl-less_nooption

# Don't use the internal copy of the zlib
sed -i \
 -e "s|BUILD_ZLIB\s*= True|BUILD_ZLIB = False|" \
 -e "s|INCLUDE\s*= ./zlib-src|INCLUDE    = /include|" \
 -e "s|LIB\s*= ./zlib-src|LIB        = /library|" \
 cpan/Compress-Raw-Zlib/config.in

./Configure -des \
 -Uuseshrplib \
 -Uusedl \
 -Uinstallusrbinperl \
 -Uusevendorprefix \
 -Duselargefiles \
 -Dusemymalloc=n \
 -A ccflags="-D_GNU_SOURCE -D_BSD_SOURCE -DNO_PERL_MALLOC_ENV -DNDEBUG" \
 -A ldflags="-static" \
 -Doptimize="$flags" \
 -Dprefix='' \
 -Dbin=/bin \
 -Dprivlib=/lib/perl5 \
 -Darchlib=/lib/perl5 \
 -Dsitelib=/lib/perl5/site_perl \
 -Dsitearch=/lib/perl5/site_perl \
 -Dman1dir=/share/man/man1 \
 -Dman3dir=/share/man/man3 \
 -Dpager=/bin/less

make -j${jobs}
make install DESTDIR=$destdir

# Replace hard links
( cd ${destdir}/bin && \
  mv perl perl${version} && \
  ln -sf perl${version} perl ; \
  ln -sf c2ph pstruct ; \
  ln -sf s2p psed ; \
)

# Compress and link manual pages (if needed)
if [ -d ${destdir}/share/man ] ; then \
  ( cd ${destdir}/share/man && \
    find . -type f -name '*.?' -exec gzip -9 {} \; ; \
  ) ; \
fi

# Replace hard links on manual pages
( cd ${destdir}/share/man/man1 && \
  ln -sf c2ph.1.gz pstruct.1.gz ; \
  ln -sf s2p.1.gz psed.1.gz ; \
)

# Copy the documentation
mkdir -p $docdir && cp -a $docs $docdir

reclinker -rf /pkg/${program}-${version} /

