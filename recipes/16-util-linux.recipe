# Build recipe for util-linux.
#
# Copyright (C) 2012 Matias A. Fonzo.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program = util-linux
version = 2.22.1
release = 1

tarname = ${program}-${version}.tar.lz
tardir = /storage/dragora/sources
archive = /storage/dragora/archive
patchdir = /storage/dragora/patches
jobs = 1

docs = AUTHORS COPYING ChangeLog NEWS README*
destdir = /package/${program}-${version}
docdir = ${destdir}/documents/${program}-${version}

[build]
cd $srcdir

# Don't build cpuset, has specific code for Glibc
zcat ${patchdir}/util-linux-no_cpuset.gz | patch -p0

# The minix support is giving errors with Musl
zcat ${patchdir}/util-linux-no_minix.gz | patch -p0

# To work with agetty and blkid
zcat ${archive}/ttydefaults.h.gz > include/ttydefaults.h
zcat ${patchdir}/util-linux-ttyutils.h.gz | patch -p0

# More patches in order to work with Musl
zcat ${patchdir}/util-linux-cfdisk_sighandler.gz | patch -p0
zcat ${patchdir}/util-linux-display.c.gz | patch -p0
zcat ${patchdir}/util-linux-pg.c.gz | patch -p0

# Change the path location for adjtime
sed -i 's@etc/adjtime@config/adjtime@g' $$(grep -rl '/etc/adjtime' .)

CC="gcc -static -Dversionsort=alphasort -D__GNU_LIBRARY__=5 -DMAXNAMLEN=255" \
CFLAGS="$flags" \
./configure $configure_args \
 --enable-fs-paths-default="/executable" \
 --enable-libuuid \
 --enable-libblkid \
 --enable-libmount \
 --enable-static \
 --disable-shared \
 --disable-su \
 --disable-sulogin \
 --disable-login \
 --disable-schedutils \
 --disable-utmpdump \
 --disable-mesg \
 --disable-kill \
 --disable-eject \
 --disable-use-tty-group \
 --enable-arch \
 --enable-reset \
 --enable-write

make -j${jobs} V=1
make install \
 usrbin_execdir=/executable \
 usrsbin_execdir=/executable \
 DESTDIR=$destdir

# Create empty directory for uuidd
mkdir -p ${destdir}/variable/uuidd

# Compress and link manual pages (if needed)
if [ -d ${destdir}/documents/man ] ; then \
  ( cd ${destdir}/documents/man && \
    find . -type f -exec gzip -9 {} \; && \
    find . -type l | while read file ; do \
      ln -sf $$(readlink $$file).gz $${file}.gz && \
      rm $$file ; \
    done ; \
  ) ; \
fi

# Copy the documentation
mkdir -p $docdir && cp -a $docs $docdir

reclinker -rf /package/${program}-${version} /

