# Build recipe for bison.
#
# Copyright (C) 2015 Matias A. Fonzo, selk@dragora.org.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program=bison
version=3.0.4
release=1

tarname=${program}-${version}.tar.gz

description="
bison - GNU parser generator.

Bison is a general-purpose parser generator that converts an annotated
context-free grammar into a deterministic LR or generalized LR (GLR)
parser employing LALR(1) parser tables. As an experimental feature,
Bison can also generate IELR(1) or canonical LR(1) parser tables.
Once you are proficient with Bison, you can use it to develop a wide
range of language parsers, from those used in simple desk calculators
to complex programming languages.

"

homepage=https://www.gnu.org/software/bison
licenses=GPLv3+

# Remote source(s)
fetch=(
  http://ftp.gnu.org/gnu/bison/$tarname
)

docs=""AUTHORS COPYING ChangeLog NEWS README* THANKS TODO""
docdir=/usr/share/doc/${program}-${version}

machine_type="$(cc -dumpmachine)"

build {
  cd "$srcdir"

  LDFLAGS="-Wl,-static" \
  ./configure $configure_args \
   --disable-nls \
   --build="$machine_type"

  make -j${jobs} V=1
  make -j${jobs} install DESTDIR="$destdir"

  # Compress info documents (if needed)
  if [[ -d ${destdir}/usr/share/info ]] ; then
    rm -f "${destdir}"/usr/share/info/dir
    gzip -9 ""${destdir}/usr/share/info/*""
  fi

  # Compress and link manual pages (if needed)
  if [[ -d ${destdir}/usr/share/man ]] ; then
    ( cd "${destdir}"/usr/share/man && \
      find . -type f -exec gzip -9 '{}' \; && \
      find . -type l | while read -r file ; do
        ln -sf "$(readlink "$file").gz" "${file}.gz" && \
        rm -- "$file"
      done
    )
  fi

  # Copy the documentation
  mkdir -p "${destdir}${docdir}" && cp -a "$docs" "${destdir}${docdir}"
}

