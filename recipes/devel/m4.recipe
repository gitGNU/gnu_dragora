# Build recipe for m4.
#
# Copyright (C) 2015 Matias A. Fonzo, selk@dragora.org.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program=m4
version=1.4.16
release=1

tarname=${program}-${version}.tar.bz2

description="
m4 - Traditional Unix macro processor.

GNU M4 is an implementation of the traditional Unix macro processor.
It is mostly SVR4 compatible although it has some extensions
(for example, handling more than 9 positional parameters to macros).

GNU M4 also has built-in functions for including files, running shell
commands, doing arithmetic, etc.

GNU M4 is a macro processor in the sense that it copies its input
to the output expanding macros as it goes.

"

homepage=https://www.gnu.org/software/m4
licenses=GPLv3+

# Remote source(s)
fetch=(
  http://ftp.gnu.org/gnu/m4/$tarname
)

docs="AUTHORS BACKLOG COPYING ChangeLog NEWS README THANKS TODO"
docdir=/usr/share/doc/${program}-${version}

build() {
  cd "$srcdir"

  set -o errexit;       # Exit immediately on any error.

  # Run fixer script
  "${worktree}"/patches/gnulibfix lib/

  # Avoid: ./stdio.h:477:1: error: 'gets' undeclared here (not in a function)
  #  _GL_WARN_ON_USE (gets, "gets is a security hole - use fgets instead");
  sed -i -e '/gets is a/d' lib/stdio.in.h

  LDFLAGS="-Wl,-static,--verbose=99" \
  ./configure $configure_args \
   ac_cv_libsigsegv=no

  make -j${jobs}
  make -j${jobs} install DESTDIR="$destdir"

  # Compress info documents (if needed)
  if [[ -d ${destdir}/usr/share/info ]] ; then
    rm -f "${destdir}"/usr/share/info/dir
    gzip -9 ""${destdir}/usr/share/info/*""
  fi

  # Compress manual pages (if needed)
  if [[ -d ${destdir}/usr/share/man ]] ; then
    ( cd "${destdir}"/usr/share/man && \
      find . -type f -exec gzip -9 '{}' \; && \
      find . -type l | while read -r file ; do
        if [[ -n $file ]] ; then
          ln -sf "$(readlink "$file").gz" "${file}.gz" && \
          rm -- "$file"
        fi
      done
    )
  fi

  # Copy the documentation
  mkdir -p "${destdir}${docdir}" && cp -a $docs "${destdir}${docdir}"
}

