# Copyright (C) 2012-2013 Matias A. Fonzo.
#
# This script is free software: you have unlimited permission
# to copy, distribute and modify it.

version=2.23.2

# Uncompression
rm -rf ${TMPDIR}/binutils-${version}
tar xf ${SRCDIR}/binutils-${version}.tar.?z* -C $TMPDIR

# Build
cd ${TMPDIR}/binutils-${version}

# Do not fail if "makeinfo" is not available
patch -Np1 -i ${PATCHDIR}/binutils/binutils-makeinfo_nofails

rm -rf ../binutils-build
mkdir ../binutils-build
cd ../binutils-build

CC="${TARGET}-${CC} -D_GNU_SOURCE -I/tools/include" \
AR="${TARGET}-ar" \
RANLIB="${TARGET}-ranlib" \
../binutils-${version}/configure LDFLAGS="--static" \
 --prefix=/tools \
 --libdir=/tools/lib \
 --with-lib-path=/tools/lib \
 --with-sysroot \
 --disable-shared \
 --disable-werror \
 --disable-nls \
 --disable-ppl-version-check \
 --disable-cloog-version-check

make $jobs && make install

# Re-adjust the linker for the final system
make -C ld clean
make -C ld LIB_PATH=/lib
cp -f ld/ld-new /tools/bin

